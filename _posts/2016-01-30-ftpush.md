---
layout: post
title: Python + FTP = FTPush или как автоматизировать загрузку на FTP
date: 2016-01-30 23:29:16
tags: ru python authomatization
---

## Предисловие

В связи с дурной привычной вместо того, что нужно сейчас, делать то, что интересно, родилась идея отправлять автоматически собираемые пакеты, поддерживаемые мной в [AUR](https://aur.archlinux.org/packages/?O=0&SeB=m&K=AlexTalker&outdated=&SB=n&SO=a&PP=50&do_Search=Go), в собственный репозиторий, дабы облегчить обновление их пользователям.

Python был выбран в связи с наличием почти на каждой системе(причина из категории "а вдруг...") и простотой написания необходимого костыля.

Если находить свеже-собранные пакеты в определённых директриях оказалось делом нехитрым, то вот отправлять их по ftp оказалось нетривиальной задачей.

Поскольку, наиболее минималичным способом общения с ftp-сервером является `ftp`, имеющий исключительно интерактивный интерфейс, вариант использования перенаправления ввода мне сразу не понравился.

Как оказалось, Python в своей стандартной библиотеке уже содержит классы для работы с FTP-сервером(модуль [`ftplib`](https://docs.python.org/3.5/library/ftplib.html)).
Сей факт избавил от необходимости искать что-то ещё.

Также, в целях безопасности, было решено считывать данные о хосте, пользователе и пароле для сервера из внешнего конфигурационного файла вместо параметров коммандной строки.

Таким образом был написан скрипт, позволяющий отделить вход на сервер от непосредственно перемещения по каталогам и передаче/удалению файлов.

## FTPush

<script src="https://gist.github.com/AlexTalker/a72068e39724c755968e.js"></script>

Идея очень проста. Первым аргументом идёт `-r`, только если необходимо удалять файлы на сервере, а не загружать их.
Далее, необязательно, можно указать путь к иному конфигурационному файлу(который, по-умолчанию, ftpush.ini), если это необходимо.
Затем Нужно передать параметр `--set-root` для того, чтобы указать директорию на сервере, в которую должны быть загружены файлы.
После необходимо перечислить пути к самим файлам. Последнее можно повторять пока пользователю необходимо.

Скрипт ищет в конфигурационном файле секцию `FTP` и считывает из неё параметры `host`(обязательно), `user`, `password`, `use_netrc` и `port`(при необходимости). Если установить значение `use_netrc` в `true`, то поиск пользователя и его пароля для данного хоста будет осуществлён в файле .netrc.

Надеюсь, этот код поможет кому-либо кроме меня. Он написан чтобы быть совместимым с _WIndows_ по возможности, но не был протестирован там.

### TODO:
 * Поддержка SFTP
 * Параметр `--quiet` чтобы убирать логирование через `print`, если необходимо.
