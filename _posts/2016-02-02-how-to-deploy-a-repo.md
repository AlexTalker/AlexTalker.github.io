---
layout: post
date: 2016-02-02 21:06:13
title: Костыли и репозитории
description: Рассказ о том, как создать собственный Arch репозиторий и зачем оно бывает нужно
tags: ru archlinux aur authomatization python
---

## Предисловие

Собственно, это несколько логическое продолжение поста [про `ftpush`](/2016/01/ftpush/).

Поскольку, несколько месяцев назад обновление части пакетов в aur было автоматизировано,
а ленивая версия скрипта, занимающегося обновлением _просто_ пересобирала пакеты,
побочным продуктом автоматизации стали готовые пакеты. Поэтому, дабы избавить дорогих
пользователей от необходимости собирать их заново, а также чтобы просто не пропадали зря,
решено было создать собственный репозиторий для их хранения.

Изначально, планировалось хранить пакеты в Dropbox, как это сделали [`pfkernel`](https://wiki.archlinux.org/index.php/Unofficial_user_repositories#pfkernel), но поскольку [с 2012 года](https://www.dropbox.com/help/16) функция Public Folder доступна только для Pro аккаунтов, по причине встроенной склонности автора к халявным решениям, идея использования Dropbox была отброшена.

Из пыльных недр памяти были изъяты воспоминания [о неплохом украинском хостинге](http://ho.ua),
дарующем его счастливым пользователям 1 ГиБ под внутренности сайта и FTP доступ ко всему этому.

## Как устроены репозитории

Для Arch Linux, репозиторий это не более чем место, где база данных, пакеты и, если существуют, подписи к ним могут быть найдены.
То есть просто директория. Никакой вложенности.

База данных может быть сгенерирована `repo-add`, `repo-remove` или другой утлитой. На самом деле она является всего-лишь сжатым
tar архивом, содержащим каталоги, имеющие названия файлов пакетов(без расширения), по-умолчанию содержащими два файла: `desc` и `depends`. Первый содержит описание пакета, а второй -- его зависимостей. Каждый из них содержит информацию в стиле:
{% highlight sh %}
%KEY%
value

%KEY2%
value1
value2
{% endhighlight %}


То есть никаких идентификаторов ключа для набора значений, кроме как начала строки с `%` нет. Также как и никаких разделителей, кроме новых строк.

Поскольку практически никаких утлит или библиотек для чтения данных о пакетах из БД не было найдено(кроме [`repose`](https://github.com/vodik/repose), но это комплексное решение для обслуживания репозитория), был написан очередной небольшой костыль для этого:

<script src="https://gist.github.com/AlexTalker/2f75155eb2d12f9a88fe.js"></script>

Код `DBReader` очень примитивен по части парсинга и не осуществляет преобразования типов. Желающие могут исправить это.

Это было необходимо, поскольку 1 ГиБ не так уж и много для пакетов размером 40-50 МиБ, обновляющихся каждый день.
Если удалить старый пакет и заменить его новым -- просто(`repo-add -R ...`), то сделать это по FTP не столь же просто(если не хочетеся переотправлять все файлы репозитория заново).

## Решение

<script src="https://gist.github.com/AlexTalker/01c8685b912fb96ef29c.js"></script>

Забираем имена свежих файлов, делаем на них символические ссылки в директории репозитория, выбираем из базы файлы для удаления на удалённом сервере, обновляем базу, удаляем старые пакеты с сервера, отправляем новые и обновлённую базу. Всё.

Примитивно, просто, костыльно.

Осталось добавить новый репозиторий в конфигурацию `pacman`-а:

{% highlight sh %}
[alextalker]
SigLevel = Optional TrustAll
Server = http://alextalker.ho.ua/aurrepo/
{% endhighlight %}

Единственным недостаток является то, что отправляются пакеты только для текущей архитектуры -- `x86_64`.
